steps:
  # Run Maven tests
  - name: 'maven:3.9-eclipse-temurin-17'
    id: 'test-backend'
    entrypoint: 'mvn'
    args: ['test']

  # Run linting (Checkstyle, SpotBugs, PMD)
  - name: 'maven:3.9-eclipse-temurin-17'
    id: 'lint-backend'
    entrypoint: 'mvn'
    args: ['verify', '-DskipTests']

  # Build the application JAR (skip on PR builds)
  - name: 'maven:3.9-eclipse-temurin-17'
    id: 'build-backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Skip build on PR builds
        if [ "$BRANCH_NAME" != "main" ]; then
          echo "PR build detected (branch: $BRANCH_NAME), skipping package step"
          echo "Build validation complete âœ“"
          exit 0
        fi
        
        echo "Building application package..."
        mvn package -DskipTests

  # Build Docker image - ONLY on main branch
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Only build image on main branch
        if [ "$BRANCH_NAME" != "main" ]; then
          echo "PR build detected (branch: $BRANCH_NAME), skipping Docker build"
          exit 0
        fi
        
        echo "Building Docker image..."
        docker build -t ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:${SHORT_SHA} \
              -t ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:latest .

  # Push Docker image - ONLY on main branch
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Only push image on main branch
        if [ "$BRANCH_NAME" != "main" ]; then
          echo "PR build detected (branch: $BRANCH_NAME), skipping Docker push"
          exit 0
        fi
        
        echo "Pushing Docker image..."
        docker push ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:${SHORT_SHA}
        docker push ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/${_SERVICE_NAME}:latest

  # Note: Cloud Run deployment is managed by Terraform
  # After image is pushed, trigger Terraform apply to update the service
  # See: recipe-management-infrastructure/terraform/environments/dev/main.tf

# Substitutions for different environments
substitutions:
  _SERVICE_NAME: 'recipe-ai-service'
  _REGION: 'europe-west2'
  _ARTIFACT_REGISTRY_REPO: 'recipe-ai'

# Use faster machine type for builds
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

# Timeout after 20 minutes
timeout: '1200s'
